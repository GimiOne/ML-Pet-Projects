# Бот: шорт альткоина при падении BTC

Идея: при резком падении BTC у нас есть короткое «окно» (обычно до ~30 минут, а сильнейшее движение в первые ~10 минут), чтобы зайти в шорт по выбранной альте из топ-30. Этот бот автоматизирует детект падения BTC и выставляет шорт по альте.

В проекте разведены части: сбор цен (API или ручной), клиент биржи (Hyperliquid, по умолчанию «сухой» режим), и стратегия.

## Структура проекта
```
/workspace/bot
  ├─ prices/                # Поставщики цен
  │   ├─ base.py            # Общий интерфейс + PriceTick
  │   ├─ binance.py         # Онлайн цены (Binance public REST)
  │   └─ manual.py          # Ручной провайдер (подставляем цены)
  ├─ exchanges/
  │   └─ hl.py              # Клиент Hyperliquid (dry-run, в примере без реального API)
  ├─ strategy/
  │   └─ drop_and_short.py  # Стратегия: детект падения BTC → шорт альты
  ├─ config.py              # Конфигурация стратегии и клиента HL (dataclasses)
  ├─ main.py                # CLI (Typer): run-live / manual-once / manual-replay
  ├─ requirements.txt       # Зависимости
  └─ README.md              # Это руководство
```

## Конфиг: где и что настраивать
Файл: `bot/config.py`

- `StrategyConfig`
  - `btc_symbol`: символ BTC у провайдера цен. По умолчанию `BTCUSDT`.
  - `alt_symbol`: символ альты, которую шортим. По умолчанию `ETHUSDT`.
  - `drop_pct_threshold`: порог падения BTC от локального максимума (в %), чтобы триггерить вход. Пример: `1.0`.
  - `lookback_seconds`: окно (сек), в котором ищется локальный максимум BTC. Пример: `300` (5 минут).
  - `entry_window_seconds`: длительность окна входа (сек) после первого триггера. Пример: `600` (10 минут).
  - `cooldown_seconds`: минимальная пауза между входами (сек). Пример: `900` (15 минут).
  - `alt_order_qty`: размер ордера по альте (в монетах/контрактах). Пример: `1.0`.
  - `leverage`: плечо (упрощённо, для dry-run). Пример: `3.0`.
  - `poll_interval_seconds`: период опроса цен (сек). В CLI задаётся флагом `--poll`.
  - `verbose`: подробный вывод.

- `HLConfig`
  - `api_key`, `api_secret`: ключи Hyperliquid (в примере не используются, см. ниже «Живой режим»).
  - `base_url`: базовый URL API HL.
  - `dry_run`: «сухой» режим. При `True` заявки не отправляются на реальную биржу, возвращается имитация результата.

Важно: в данном учебном примере реальная интеграция с HL не реализована, метод реального размещения ордера помечен как `NotImplementedError`. Это сделано специально, чтобы безопасно тестировать логику без риска реальных сделок.

## Где хранить ключи, сид-фразы, API-ключи
- Никогда не храните секреты в репозитории (в коде, в `git`).
- Рекомендуемые варианты:
  - Переменные окружения (например, `HL_API_KEY`, `HL_API_SECRET`).
  - Локальные менеджеры секретов/хранилища (1Password, Bitwarden, AWS/GCP Secret Manager и т.п.).
  - `.env`-файл (не коммитить!) + загрузка через dotenv (в этом примере не подключено, можно добавить при интеграции реального API).

Как подключить в этом проекте, когда вы добавите реальный вызов HL:
- В `main.py` при инициализации `HyperliquidClient` пробрасывайте ключи в `HLConfig` из окружения, например:
```
# псевдокод
import os
hl = HyperliquidClient(HLConfig(
    api_key=os.environ.get("HL_API_KEY"),
    api_secret=os.environ.get("HL_API_SECRET"),
    dry_run=False,
))
```
- Сид-фразы (seed phrases) никогда не передавайте в код или в переменные окружения без шифрования. Для централизованных бирж обычно используются API-ключи, а для DEX — отдельные безопасные кошельки и подписи.

Повторим: текущий пример НЕ отправляет реальные ордера. Для «боевого» режима потребуется дописать реализацию клиента HL и аккуратно подключить секреты.

## Установка
В средах с ограничениями (Debian/Ubuntu) может потребоваться флаг `--break-system-packages`:
```bash
python3 -m pip install --break-system-packages -r /workspace/bot/requirements.txt
```
Или используйте виртуальное окружение (если доступно `python3-venv`):
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Режимы и пошаговый запуск
### 1) Тестовый режим (ручные цены, без API)
- Одноразовый тик (передаём цены вручную, проверяем логику входа):
```bash
python3 -m bot.main manual-once \
  --btc 68000 \
  --alt 3400 \
  --alt-symbol ETHUSDT \
  --threshold 1.0 \
  --lookback 300 \
  --qty 1 \
  --dry-run
```
- Пошаговая симуляция (последовательности цен BTC и альты):
```bash
python3 -m bot.main manual-replay --alt-symbol ETHUSDT \
  --btc-seq 70000,69500,69000,68500,68000 \
  --alt-seq 3500,3470,3440,3410,3380 \
  --threshold 1.0 --lookback 300 --qty 1 --dry-run
```
Ожидаемо, когда падение BTC от локального максимума превысит порог, стратегия попытается поставить шорт по альте (в dry-run вернётся фиктивный `order_id`).

### 2) «Живой» тест (онлайн-цены Binance, без реальных ордеров)
- Старт с опросом цен и dry-run ордерами:
```bash
python3 -m bot.main run-live \
  --alt ETHUSDT \
  --threshold 1.0 \
  --lookback 300 \
  --qty 1 \
  --dry-run
```
Стратегия будет опрашивать public REST Binance и при срабатывании условий делать «сухую» сделку.

### 3) Боевой режим (реальные ордера HL)
- В текущей версии не реализован сознательно. Для боевого режима необходимо:
  1. Реализовать реальные вызовы API Hyperliquid в `exchanges/hl.py`.
  2. Подключить и безопасно прочитать ключи (`HL_API_KEY`, `HL_API_SECRET`) из окружения или менеджера секретов.
  3. Запускать с `--dry-run False` только после полноценного тестирования и с добавлением риск-менеджмента (стоп-лоссы, лимиты, ретраи, персистентность состояний, защита от повторных входов и т.п.).

## CLI: команды и флаги
Общий хелп:
```bash
python3 -m bot.main --help
```

### Команда: run-live — Работа с онлайн-ценами (Binance)
- `--alt` (str): символ альты, например `ETHUSDT`.
- `--threshold` (float): порог падения BTC от локального максимума в процентах, чтобы триггерить вход, напр. `1.0`.
- `--lookback` (int, сек): окно для поиска локального максимума BTC, напр. `300`.
- `--qty` (float): размер ордера по альте (монеты/контракты), напр. `1.0`.
- `--leverage` (float): плечо (для dry-run логики), напр. `3.0`.
- `--poll` (float, сек): период опроса цен, напр. `2.0`.
- `--dry-run` (bool): сухой режим клиента HL. По умолчанию включён. В этом режиме ордера не отправляются на реальную биржу.
- `--verbose` (bool): подробный вывод диагностики.

Пример:
```bash
python3 -m bot.main run-live --alt AVAXUSDT --threshold 1.2 --lookback 300 --qty 2 --leverage 3 --poll 2 --dry-run --verbose
```

### Команда: manual-once — Одноразовый шаг стратегии (ручные цены)
- `--btc` (float): BTC цена.
- `--alt` (float): ALT цена.
- `--alt-symbol` (str): символ альты, напр. `ETHUSDT`.
- `--threshold` (float): порог падения BTC от локального максимума (в %).
- `--lookback` (int, сек): окно для локального максимума BTC.
- `--qty` (float): размер ордера по альте.
- `--leverage` (float): плечо (для dry-run).
- `--dry-run` (bool): сухой режим HL.
- `--verbose` (bool): подробный вывод.

Пример:
```bash
python3 -m bot.main manual-once --btc 70000 --alt 3500 --alt-symbol ETHUSDT --threshold 1.0 --lookback 300 --qty 1 --leverage 3 --dry-run --verbose
```

### Команда: manual-replay — Пошаговая симуляция (ручные цены)
- `--btc-seq` (CSV float): последовательность цен BTC, через запятую.
- `--alt-seq` (CSV float): последовательность цен альты, через запятую.
- `--alt-symbol` (str): символ альты.
- `--threshold` (float): порог падения BTC от локального максимума (в %).
- `--lookback` (int, сек): окно для локального максимума BTC.
- `--qty` (float): размер ордера по альте.
- `--leverage` (float): плечо (для dry-run).
- `--dry-run` (bool): сухой режим HL.
- `--verbose` (bool): подробный вывод.
- `--step-delay` (float, сек): необязательная задержка между «тиками» в симуляции.

Пример:
```bash
python3 -m bot.main manual-replay --alt-symbol SUIUSDT \
  --btc-seq 70000,69300,68900,68800 \
  --alt-seq  140,   138,   133,   132 \
  --threshold 1.0 --lookback 300 --qty 10 --leverage 3 --dry-run --verbose --step-delay 0
```

## Логика стратегии (вкратце)
- Поддерживается история цен BTC в окне `lookback_seconds`.
- На каждом тике считается падение от локального максимума в этом окне. Если падение ≥ `drop_pct_threshold`, помечается время первого триггера и активируется «окно входа» (`entry_window_seconds`).
- Если мы находимся в окне входа, нет `cooldown`, и падение подтверждено, выставляется шорт по выбранной альте (в этом примере — в dry-run режиме HL).

## Безопасность, ограничения и дальнейшие шаги
- Пример учебный: нет реального API HL, риск-менеджмента, стоп-лоссов, ретраев, журналирования в БД, персистентности состояний, мониторинга и алертов.
- Для продакшна обязательно добавить:
  - Полноценный клиент HL (REST/WS, подписи, проверка балансов/маржи, расчёт размера позиции, лимиты).
  - Риск-менеджмент (стоп-лосс/тейк-профит/макс. дневной убыток/ограничение размера позиции).
  - Обработку сетевых ошибок, повторные попытки, бэкофф, таймауты.
  - Персистентность (state, логи сделок, аудит).
  - Надёжное управление секретами.

## Быстрый старт
```bash
# Установка зависимостей (вариант без venv)
python3 -m pip install --break-system-packages -r /workspace/bot/requirements.txt

# Хелп по CLI
python3 -m bot.main --help

# Минимальный dry-run с онлайн ценами
python3 -m bot.main run-live --alt ETHUSDT --threshold 1.0 --lookback 300 --qty 1 --dry-run

# Минимальный ручной тест
python3 -m bot.main manual-once --btc 70000 --alt 3500 --alt-symbol ETHUSDT --threshold 1.0 --lookback 300 --qty 1 --dry-run
```